import React, { useState, useEffect } from 'react';
import { Plus, Trash2, Swords, Play, Pause, SkipForward } from 'lucide-react';

export default function CombatTracker() {
  const [combatants, setCombatants] = useState([]);
  const [currentTurn, setCurrentTurn] = useState(0);
  const [round, setRound] = useState(1);
  const [inCombat, setInCombat] = useState(false);
  const [newCombatant, setNewCombatant] = useState({
    name: '',
    initiative: '',
    hp: '',
    maxHp: '',
    ac: ''
  });

  // Load from persistent storage on mount
  useEffect(() => {
    loadCombat();
  }, []);

  // Save to persistent storage whenever state changes
  useEffect(() => {
    if (combatants.length > 0 || inCombat) {
      saveCombat();
    }
  }, [combatants, currentTurn, round, inCombat]);

  const loadCombat = async () => {
    try {
      const result = await window.storage.get('combat-state', true);
      if (result) {
        const state = JSON.parse(result.value);
        setCombatants(state.combatants || []);
        setCurrentTurn(state.currentTurn || 0);
        setRound(state.round || 1);
        setInCombat(state.inCombat || false);
      }
    } catch (error) {
      console.log('No saved combat found, starting fresh');
    }
  };

  const saveCombat = async () => {
    try {
      const state = {
        combatants,
        currentTurn,
        round,
        inCombat,
        lastUpdated: Date.now()
      };
      await window.storage.set('combat-state', JSON.stringify(state), true);
    } catch (error) {
      console.error('Failed to save combat:', error);
    }
  };

  const addCombatant = () => {
    if (!newCombatant.name || !newCombatant.initiative) return;

    const combatant = {
      id: Date.now(),
      name: newCombatant.name,
      initiative: parseInt(newCombatant.initiative),
      hp: parseInt(newCombatant.hp) || 0,
      maxHp: parseInt(newCombatant.maxHp) || 0,
      ac: parseInt(newCombatant.ac) || 10,
      conditions: []
    };

    const updated = [...combatants, combatant].sort((a, b) => b.initiative - a.initiative);
    setCombatants(updated);
    setNewCombatant({ name: '', initiative: '', hp: '', maxHp: '', ac: '' });
  };

  const removeCombatant = (id) => {
    setCombatants(combatants.filter(c => c.id !== id));
  };

  const updateHP = (id, change) => {
    setCombatants(combatants.map(c => 
      c.id === id ? { ...c, hp: Math.max(0, Math.min(c.maxHp, c.hp + change)) } : c
    ));
  };

  const startCombat = () => {
    if (combatants.length === 0) return;
    setInCombat(true);
    setCurrentTurn(0);
    setRound(1);
  };

  const endCombat = () => {
    setInCombat(false);
    setCurrentTurn(0);
    setRound(1);
  };

  const nextTurn = () => {
    if (currentTurn === combatants.length - 1) {
      setCurrentTurn(0);
      setRound(round + 1);
    } else {
      setCurrentTurn(currentTurn + 1);
    }
  };

  const resetCombat = async () => {
    setCombatants([]);
    setCurrentTurn(0);
    setRound(1);
    setInCombat(false);
    try {
      await window.storage.delete('combat-state', true);
    } catch (error) {
      console.error('Failed to delete combat state:', error);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-900 via-red-900 to-gray-900 p-4">
      <div className="max-w-6xl mx-auto">
        {/* Header */}
        <div className="bg-gray-800 rounded-lg shadow-2xl p-6 mb-6 border-2 border-red-700">
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-3">
              <Swords className="w-8 h-8 text-red-500" />
              <h1 className="text-3xl font-bold text-white">Combat Tracker</h1>
            </div>
            <div className="text-right">
              <div className="text-sm text-gray-400">Round</div>
              <div className="text-3xl font-bold text-red-500">{round}</div>
            </div>
          </div>

          {/* Combat Controls */}
          <div className="flex gap-3">
            {!inCombat ? (
              <button
                onClick={startCombat}
                disabled={combatants.length === 0}
                className="flex items-center gap-2 px-6 py-3 bg-green-600 hover:bg-green-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white rounded-lg font-semibold transition"
              >
                <Play className="w-5 h-5" />
                Start Combat
              </button>
            ) : (
              <>
                <button
                  onClick={nextTurn}
                  className="flex items-center gap-2 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition"
                >
                  <SkipForward className="w-5 h-5" />
                  Next Turn
                </button>
                <button
                  onClick={endCombat}
                  className="flex items-center gap-2 px-4 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition"
                >
                  <Pause className="w-5 h-5" />
                  End Combat
                </button>
              </>
            )}
            <button
              onClick={resetCombat}
              className="ml-auto px-4 py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-semibold transition"
            >
              Reset All
            </button>
          </div>
        </div>

        {/* Add Combatant Form */}
        <div className="bg-gray-800 rounded-lg shadow-xl p-6 mb-6 border border-gray-700">
          <h2 className="text-xl font-bold text-white mb-4">Add Combatant</h2>
          <div className="grid grid-cols-1 md:grid-cols-6 gap-3">
            <input
              type="text"
              placeholder="Name"
              value={newCombatant.name}
              onChange={(e) => setNewCombatant({ ...newCombatant, name: e.target.value })}
              className="md:col-span-2 px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600 focus:border-red-500 focus:outline-none"
            />
            <input
              type="number"
              placeholder="Initiative"
              value={newCombatant.initiative}
              onChange={(e) => setNewCombatant({ ...newCombatant, initiative: e.target.value })}
              className="px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600 focus:border-red-500 focus:outline-none"
            />
            <input
              type="number"
              placeholder="HP"
              value={newCombatant.hp}
              onChange={(e) => setNewCombatant({ ...newCombatant, hp: e.target.value, maxHp: e.target.value })}
              className="px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600 focus:border-red-500 focus:outline-none"
            />
            <input
              type="number"
              placeholder="AC"
              value={newCombatant.ac}
              onChange={(e) => setNewCombatant({ ...newCombatant, ac: e.target.value })}
              className="px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600 focus:border-red-500 focus:outline-none"
            />
            <button
              onClick={addCombatant}
              className="flex items-center justify-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition"
            >
              <Plus className="w-5 h-5" />
              Add
            </button>
          </div>
        </div>

        {/* Combatants List */}
        <div className="space-y-3">
          {combatants.length === 0 ? (
            <div className="bg-gray-800 rounded-lg shadow-xl p-12 text-center border border-gray-700">
              <Swords className="w-16 h-16 text-gray-600 mx-auto mb-4" />
              <p className="text-gray-400 text-lg">No combatants yet. Add some to begin!</p>
            </div>
          ) : (
            combatants.map((combatant, index) => (
              <div
                key={combatant.id}
                className={`bg-gray-800 rounded-lg shadow-xl p-4 border-2 transition ${
                  inCombat && index === currentTurn
                    ? 'border-yellow-500 bg-gray-750'
                    : 'border-gray-700'
                }`}
              >
                <div className="flex items-center gap-4">
                  {/* Initiative */}
                  <div className="flex-shrink-0 w-16 h-16 bg-red-600 rounded-full flex items-center justify-center">
                    <span className="text-2xl font-bold text-white">{combatant.initiative}</span>
                  </div>

                  {/* Name & AC */}
                  <div className="flex-grow">
                    <div className="flex items-center gap-3 mb-2">
                      <h3 className="text-xl font-bold text-white">{combatant.name}</h3>
                      {inCombat && index === currentTurn && (
                        <span className="px-3 py-1 bg-yellow-500 text-gray-900 text-sm font-bold rounded-full">
                          ACTIVE
                        </span>
                      )}
                    </div>
                    <div className="text-gray-400">AC: {combatant.ac}</div>
                  </div>

                  {/* HP Controls */}
                  <div className="flex items-center gap-3">
                    <button
                      onClick={() => updateHP(combatant.id, -1)}
                      className="w-10 h-10 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold text-xl transition"
                    >
                      -
                    </button>
                    <div className="text-center min-w-24">
                      <div className="text-2xl font-bold text-white">
                        {combatant.hp}/{combatant.maxHp}
                      </div>
                      <div className="text-xs text-gray-400">HP</div>
                      <div className="w-full bg-gray-700 rounded-full h-2 mt-1">
                        <div
                          className="bg-green-500 h-2 rounded-full transition-all"
                          style={{ width: `${(combatant.hp / combatant.maxHp) * 100}%` }}
                        />
                      </div>
                    </div>
                    <button
                      onClick={() => updateHP(combatant.id, 1)}
                      className="w-10 h-10 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold text-xl transition"
                    >
                      +
                    </button>
                  </div>

                  {/* Delete */}
                  <button
                    onClick={() => removeCombatant(combatant.id)}
                    className="w-10 h-10 bg-gray-700 hover:bg-red-600 text-gray-400 hover:text-white rounded-lg transition flex items-center justify-center"
                  >
                    <Trash2 className="w-5 h-5" />
                  </button>
                </div>
              </div>
            ))
          )}
        </div>

        {/* Info */}
        <div className="mt-6 text-center text-gray-500 text-sm">
          <p>ðŸ’¡ This tracker syncs in real-time with all connected players</p>
        </div>
      </div>
    </div>
  );
}
