<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Combat Tracker - DM Control Panel</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(21deg, #2d1b3d, #1a0d2e, #0d0d0d);
            color: #e0e0e0;
            min-height: 100vh;
        }

        /* Chrome, Safari, Edge, Opera */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }

        /* Firefox */
        input[type=number] {
          -moz-appearance: textfield;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 2.5fr;
            gap: 0px;
            margin-bottom: 20px;
        }

        h1, h2 {
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-top: 0;
        }

        h1 {
            font-size: 2.5em;
            color: #f33a21; 
        }

        h2 {
            font-size: 1.5em;
            color: #f33a21;
        }

        .session-panel {
            background: rgba(15, 52, 96, 0.8);
            border-radius: 15px;
            padding: 20px;
            margin: 30px;
            margin-bottom: 0;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(233, 69, 96, 0.3);
        }

        .form-panel {
            background: rgba(15, 52, 96, 0.8);
            border-radius: 15px;
            padding: 20px;
            margin: 30px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(233, 69, 96, 0.3);
        }

        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #f33a21;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
            font-size: 14px;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #f33a21;
            box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.2);
        }

        .combat-panel {
            background: rgba(15, 52, 96, 0.8);
            border-radius: 15px;
            padding: 20px;
            margin: 30px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(233, 69, 96, 0.3);
            height: auto;
            overflow: hidden;
        }

        .turn-panel {
            text-align: center;
            margin-bottom: 20px;
            height: 9.5em;
            background: rgba(220, 53, 70, 0.295);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(220, 53, 69, 0.3);
        }

        .current-turn {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-radius: 8px;
        }

        .turn-grid {
            margin-top: 10px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            place-items: center;
            width: 25em;
            position: absolute;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .btn {
            background: linear-gradient(45deg, #e94560, #f27121);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: bold;
            transition: all 0.3s ease;
            text-align: center;
            max-width: 120px;
            cursor: pointer;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: bold;
            transition: all 0.3s ease;
            text-align: center;
            max-width: 120px;
            cursor: pointer;
        }

        .btn-link {
            background: linear-gradient(45deg, #2835a7, #20c3c9);
            border: none;
            color: white;
            padding: 12px 20px;
            margin-left: 25%;
            border-radius: 8px;
            font-weight: bold;
            transition: all 0.3s ease;
            text-align: center;
            max-width: 50%;
            cursor: pointer;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(233, 69, 96, 0.664);
        }

        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(88, 233, 69, 0.664);
        }

        .btn-link:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(69, 195, 233, 0.664);
        }

        .character-list {
            margin-top: 20px;
        }

        .character-item {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .character-item.active-turn {
            background: rgba(243, 58, 33, 0.3);
            border-color: #f33a21;
            box-shadow: 0 0 10px rgba(243, 58, 33, 0.5);
        }

        .character-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .character-portrait {
            flex-shrink: 0;
        }

        .character-portrait img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #f33a21;
            transition: transform 0.2s ease;
            display: block;
        }

        .character-portrait img:hover {
            transform: scale(1.05);
        }

        .portrait-fallback {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, #f33a21, #e94560);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 24px;
            border: 2px solid #f33a21;
            flex-shrink: 0;
        }

        .character-details-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .character-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 0;
        }

        .character-details {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 0;
        }

        .character-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-shrink: 0;
        }

        .switch {
          position: relative;
          width: 50px;
          height: 28px;
        }

        .switch input {
          opacity: 0;
          width: 0;
          height: 0;
        }

        .slider {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: #ccc;
          -webkit-transition: .3s;
          transition: .3s;
        }

        .slider:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(236, 141, 16, 0.952);
        }

        .slider:before {
          position: absolute;
          content: "";
          height: 21px;
          width: 21px;
          left: 4px;
          bottom: 4px;
          background-color: white;
          -webkit-transition: .3s;
          transition: .3s;
        }

        input:checked + .slider {
          background-color: #f39821;
        }

        input:focus + .slider {
          box-shadow: 0 0 1px #f39821;
        }

        input:checked + .slider:before {
          -webkit-transform: translateX(21px);
          -ms-transform: translateX(21px);
          transform: translateX(21px);
        }

        .slider.round {
          border-radius: 34px;
        }

        .slider.round:before {
          border-radius: 50%;
        } 

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group .label-text {
            margin-bottom: 0;
            color: #f33a21;
            font-weight: bold;
        }

        .legendary-resistance-container {
            margin-top: 5px;
        }

        .legendary-resistance-boxes {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .resistance-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid #f33a21;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .resistance-checkbox:hover {
            background: rgba(243, 58, 33, 0.2);
            transform: translateY(-1px);
        }

        .resistance-checkbox.used {
            background: rgba(243, 58, 33, 0.6);
            border-color: #ff6b6b;
        }

        .resistance-checkbox.used::after {
            content: "âœ—";
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1 style="margin-top: 20px">DM Control Panel</h1>
    
    <div class="session-panel">
        <h2>Combat Session</h2>
        <div class="btn-link" onclick="copyLink()" id="playerLinkButton">Loading...</div>
    </div>

    <div class="main-grid">
        <div class="form-panel">
            <h2>Add Character</h2>
            <div class="form-group">
                <input type="text" id="charName" placeholder="Name">
            </div>
            <div class="form-group">
                <input type="number" id="charInitiative" placeholder="Initiative">
            </div>
            <div class="form-group">
                <input type="text" id="statsURL" placeholder="Stats URL">
            </div>
            <div class="form-group">
                <input type="text" id="portraitURL" placeholder="Portrait URL">
            </div>
            <div class="form-group">
                <div class="checkbox-group">
                    <label class="switch">
                        <input type="checkbox" id="hasLegendarySaves">
                        <span class="slider round"></span>
                    </label>
                    <label for="hasLegendarySaves" class="label-text">Legendary Resistances</label>
                </div>
            </div>
            <div class="btn-secondary" onclick="addChar()">Add Character</div>
        </div>
        
        <div class="combat-panel">
            <div class="turn-panel">
                <h1>Round <span id="roundNumber">1</span></h1>
                <div class="current-turn" id="currentTurnDisplay">
                    No characters added yet
                </div>
                <div class="turn-grid">
                    <div class="btn" onclick="previousTurn()">Previous Turn</div>
                    <div class="btn-secondary" onclick="nextTurn()">Next Turn</div>
                </div>
            </div>
            
            <div class="character-list" id="characterList">
                <!-- Characters will be dynamically added here -->
            </div>
        </div>
    </div>

    <script>
        // ===== SUPABASE CONFIGURATION =====
        // REPLACE THESE WITH YOUR ACTUAL CREDENTIALS
        const SUPABASE_URL = 'https://gadbykwowuhlqsdxooxf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhZGJ5a3dvd3VobHFzZHhvb3hmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNTgxMzIsImV4cCI6MjA3ODczNDEzMn0.6pV_6Hy6_cP14MnAqrnMYynWw2HPj8kNRLfTkuA3pkQ';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ===== GAME STATE =====
        let gameState = {
            chars: [],
            currentTurn: 0,
            round: 1,
        };

        let editingCharId = null;
        let sessionId = getOrCreateSessionId();

        // ===== INITIALIZATION =====
        function getOrCreateSessionId() {
            let id = localStorage.getItem('sessionId');
            if (!id) {
                id = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('sessionId', id);
            }
            return id;
        }

        async function init() {
            await loadFromSupabase();
            subscribeToChanges();
            createPlayerLink();
            updateDisplay();
        }

        // ===== SUPABASE OPERATIONS =====
        async function loadFromSupabase() {
            try {
                const { data, error } = await supabase
                    .from('combat_sessions')
                    .select('*')
                    .eq('session_id', sessionId)
                    .single();
                
                if (error && error.code !== 'PGRST116') {
                    console.error('Error loading:', error);
                    return;
                }
                
                if (data) {
                    gameState.chars = data.chars || [];
                    gameState.currentTurn = data.current_turn || 0;
                    gameState.round = data.round || 1;
                }
            } catch (error) {
                console.error('Load error:', error);
            }
        }

        async function syncToPlayers() {
            try {
                const { error } = await supabase
                    .from('combat_sessions')
                    .upsert({
                        session_id: sessionId,
                        chars: gameState.chars,
                        current_turn: gameState.currentTurn,
                        round: gameState.round,
                        updated_at: new Date().toISOString()
                    });
                
                if (error) {
                    console.error('Error syncing:', error);
                }
            } catch (error) {
                console.error('Sync error:', error);
            }
        }

        function subscribeToChanges() {
            supabase
                .channel('combat_updates')
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'combat_sessions',
                        filter: `session_id=eq.${sessionId}`
                    }, 
                    (payload) => {
                        if (payload.new) {
                            gameState.chars = payload.new.chars || [];
                            gameState.currentTurn = payload.new.current_turn || 0;
                            gameState.round = payload.new.round || 1;
                            updateDisplay();
                        }
                    }
                )
                .subscribe();
        }

        // ===== CHARACTER MANAGEMENT =====
        function addChar() {
            const name = document.getElementById('charName').value.trim();
            const initiative = parseInt(document.getElementById('charInitiative').value);
            const stats = document.getElementById('statsURL').value.trim();
            const portrait = document.getElementById('portraitURL').value.trim();
            const hasLegendarySaves = document.getElementById('hasLegendarySaves').checked;

            if (!name || isNaN(initiative)) {
                alert('Please enter a name and initiative value');
                return;
            }

            if (editingCharId) {
                const char = gameState.chars.find(c => c.id === editingCharId);
                if (char) {
                    char.name = name;
                    char.initiative = initiative;
                    char.stats = stats || null;
                    char.portrait = portrait || null;
                    char.legendarySaves = hasLegendarySaves ? { max: 3, current: 3, used: [false, false, false] } : null;
                }
                editingCharId = null;
                document.querySelector('.form-panel .btn-secondary').textContent = 'Add Character';
            } else {
                const char = {
                    id: Date.now(),
                    name,
                    initiative,
                    stats: stats || null,
                    portrait: portrait || null,
                    conditions: [],
                    legendarySaves: hasLegendarySaves ? { max: 3, current: 3, used: [false, false, false] } : null
                };
                gameState.chars.push(char);
            }
            
            gameState.chars.sort((a, b) => b.initiative - a.initiative);

            document.getElementById('charName').value = '';
            document.getElementById('charInitiative').value = '';
            document.getElementById('statsURL').value = '';
            document.getElementById('portraitURL').value = '';
            document.getElementById('hasLegendarySaves').checked = false;

            updateDisplay();
            syncToPlayers();
        }

        function removeChar(charId) {
            if (confirm('Are you sure you want to remove this character?')) {
                const charIndex = gameState.chars.findIndex(c => c.id === charId);
                if (charIndex !== -1) {
                    gameState.chars.splice(charIndex, 1);
                    
                    if (gameState.currentTurn >= gameState.chars.length) {
                        gameState.currentTurn = 0;
                    }
                    
                    updateDisplay();
                    syncToPlayers();
                }
            }
        }

        function editChar(charId) {
            const char = gameState.chars.find(c => c.id === charId);
            if (char) {
                document.getElementById('charName').value = char.name;
                document.getElementById('charInitiative').value = char.initiative;
                document.getElementById('statsURL').value = char.stats || '';
                document.getElementById('portraitURL').value = char.portrait || '';
                document.getElementById('hasLegendarySaves').checked = !!char.legendarySaves;
                
                editingCharId = charId;
                document.querySelector('.form-panel .btn-secondary').textContent = 'Update Character';
            }
        }

        // ===== TURN MANAGEMENT =====
        function nextTurn() {
            if (gameState.chars.length === 0) return;
            
            gameState.currentTurn++;
            if (gameState.currentTurn >= gameState.chars.length) {
                gameState.currentTurn = 0;
                gameState.round++;
            }
            
            updateDisplay();
            syncToPlayers();
        }

        function previousTurn() {
            if (gameState.chars.length === 0) return;
            
            gameState.currentTurn--;
            if (gameState.currentTurn < 0) {
                gameState.currentTurn = gameState.chars.length - 1;
                gameState.round = Math.max(1, gameState.round - 1);
            }
            
            updateDisplay();
            syncToPlayers();
        }

        // ===== LEGENDARY RESISTANCES =====
        function useLegendaryResistance(charId, resistanceIndex) {
            const char = gameState.chars.find(c => c.id === charId);
            if (char && char.legendarySaves) {
                if (!char.legendarySaves.used) {
                    char.legendarySaves.used = [false, false, false];
                }
                char.legendarySaves.used[resistanceIndex] = !char.legendarySaves.used[resistanceIndex];
                char.legendarySaves.current = char.legendarySaves.used.filter(used => !used).length;
                
                updateDisplay();
                syncToPlayers();
            }
        }

        function resetLegendarySaves(charId) {
            const char = gameState.chars.find(c => c.id === charId);
            if (char && char.legendarySaves) {
                char.legendarySaves.current = char.legendarySaves.max;
                char.legendarySaves.used = [false, false, false];
                updateDisplay();
                syncToPlayers();
            }
        }

        // ===== UI UPDATE =====
        function updateDisplay() {
            document.getElementById('roundNumber').textContent = gameState.round;
            
            const currentTurnDisplay = document.getElementById('currentTurnDisplay');
            if (gameState.chars.length === 0) {
                currentTurnDisplay.textContent = 'No characters added yet';
            } else {
                const currentChar = gameState.chars[gameState.currentTurn];
                currentTurnDisplay.textContent = `Current Turn: ${currentChar.name}`;
            }
            
            const characterList = document.getElementById('characterList');
            characterList.innerHTML = '';

            gameState.chars.forEach((char, index) => {
                const charDiv = document.createElement('div');
                charDiv.className = `character-item ${index === gameState.currentTurn ? 'active-turn' : ''}`;
                
                const charInfo = document.createElement('div');
                charInfo.className = 'character-info';
                
                const portraitContainer = document.createElement('div');
                portraitContainer.className = 'character-portrait';
                
                if (char.portrait) {
                    const portraitImg = document.createElement('img');
                    portraitImg.src = char.portrait;
                    portraitImg.alt = `${char.name} portrait`;
                    portraitImg.onerror = function() {
                        this.style.display = 'none';
                        const fallback = document.createElement('div');
                        fallback.className = 'portrait-fallback';
                        fallback.textContent = char.name.charAt(0).toUpperCase();
                        portraitContainer.appendChild(fallback);
                    };
                    portraitContainer.appendChild(portraitImg);
                } else {
                    const fallback = document.createElement('div');
                    fallback.className = 'portrait-fallback';
                    fallback.textContent = char.name.charAt(0).toUpperCase();
                    portraitContainer.appendChild(fallback);
                }
                
                const charDetailsContainer = document.createElement('div');
                charDetailsContainer.className = 'character-details-container';
                
                const charName = document.createElement('div');
                charName.className = 'character-name';
                charName.textContent = char.name;
                charDetailsContainer.appendChild(charName);
                
                const charDetails = document.createElement('div');
                charDetails.className = 'character-details';
                charDetails.textContent = `Initiative: ${char.initiative}${char.legendarySaves ? ` | Legendary Resistances: ${char.legendarySaves.current}/${char.legendarySaves.max}` : ''}`;
                charDetailsContainer.appendChild(charDetails);
                
                if (char.stats) {
                    const statsLink = document.createElement('div');
                    statsLink.className = 'character-details';
                    const link = document.createElement('a');
                    link.href = char.stats;
                    link.target = '_blank';
                    link.style.color = '#f33a21';
                    link.textContent = 'View Stats';
                    statsLink.appendChild(link);
                    charDetailsContainer.appendChild(statsLink);
                }
                
                if (char.legendarySaves) {
                    if (!char.legendarySaves.used) {
                        char.legendarySaves.used = [false, false, false];
                    }
                    
                    const resistanceContainer = document.createElement('div');
                    resistanceContainer.className = 'character-details legendary-resistance-container';
                    
                    const checkboxContainer = document.createElement('div');
                    checkboxContainer.className = 'legendary-resistance-boxes';
                    
                    for (let i = 0; i < 3; i++) {
                        const checkbox = document.createElement('div');
                        checkbox.className = `resistance-checkbox ${char.legendarySaves.used[i] ? 'used' : ''}`;
                        checkbox.onclick = () => useLegendaryResistance(char.id, i);
                        checkboxContainer.appendChild(checkbox);
                    }
                    
                    resistanceContainer.appendChild(checkboxContainer);
                    charDetailsContainer.appendChild(resistanceContainer);
                }
                
                charInfo.appendChild(portraitContainer);
                charInfo.appendChild(charDetailsContainer);
                
                const charActions = document.createElement('div');
                charActions.className = 'character-actions';
                
                const editBtn = document.createElement('div');
                editBtn.className = 'btn-secondary btn-small';
                editBtn.textContent = 'Edit';
                editBtn.onclick = () => editChar(char.id);
                charActions.appendChild(editBtn);
                
                if (char.legendarySaves) {
                    const resetBtn = document.createElement('div');
                    resetBtn.className = 'btn btn-small';
                    resetBtn.textContent = 'Reset Resistances';
                    resetBtn.onclick = () => resetLegendarySaves(char.id);
                    charActions.appendChild(resetBtn);
                }
                
                const removeBtn = document.createElement('div');
                removeBtn.className = 'btn btn-small';
                removeBtn.textContent = 'Remove';
                removeBtn.onclick = () => removeChar(char.id);
                charActions.appendChild(removeBtn);
                
                charDiv.appendChild(charInfo);
                charDiv.appendChild(charActions);
                characterList.appendChild(charDiv);
            });
        }

        // ===== PLAYER LINK =====
        function createPlayerLink() {
            const playerLink = window.location.origin + "/player.html?session=" + sessionId;
            const playerLinkButton = document.getElementById('playerLinkButton');
            if (playerLinkButton) {
                playerLinkButton.textContent = `Player Display Link: ${sessionId}`;
            }
        }

        function copyLink() {
            const playerLink = window.location.origin + "/player.html?session=" + sessionId;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(playerLink).then(() => {
                    const playerLinkButton = document.getElementById('playerLinkButton');
                    const originalText = playerLinkButton.textContent;
                    playerLinkButton.textContent = 'Copied!';
                    setTimeout(() => {
                        playerLinkButton.textContent = originalText;
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    alert('Link: ' + playerLink);
                });
            } else {
                alert('Link: ' + playerLink);
            }
        }

        // ===== START =====
        window.onload = init;
    </script>
</body>
</html>
